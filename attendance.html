<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Attendance</title>

<style>
body {
    margin: 0;
    font-family: tahoma, sans-serif;
    height: 100vh;
    overflow: hidden;

    /* ðŸ”¥ DOT BACKGROUND */
    background: url("bgdot.jpeg") repeat;
}
.container {
    width: 900px;
    background: #ffffff;
    padding: 40px;
    box-shadow: 0 0 25px rgba(0,0,0,0.08);
    border-radius: 12px;

    height: calc(100vh - 80px); /* ðŸ”¥ FIXED */
    overflow-y: auto;
}

.main-wrapper {
    margin-left: 230px;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
}
h2 {
    display: inline-block;
    background: linear-gradient(to right,  #07AFC0, #1aa853);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 28px;
    margin-bottom: 30px;
    font-weight: bold;
}

.row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 35px;
}

.inputGroup {
    width: 32%;
    display: flex;
    flex-direction: column;
}

.inputGroup label {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 8px;
}

.selectBox, input {
    border: none;
    background: transparent;
    border-bottom: 3px solid #9de79d;
    padding: 10px 5px;
    font-size: 16px;
    outline: none;
}

.btnRow {
    display: flex;
    gap: 15px;
    margin-top: -15px;
}

.btnRow button {
    padding: 10px 25px;
    background: linear-gradient(to right, #07AFC0, #1aa853);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
}
.btnRow button:hover { background: linear-gradient(to right, #1aa853, #07AFC0); }


.attCard {
    background: #f7f7f7;
    border-radius: 12px;
    padding: 15px;
    margin-top: 20px;
    border-left: 6px solid #34c759;
}

.twoCol {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.left, .right {
    width: 48%;
}

.delBtn {
    padding: 7px 15px;
    border: none;
    border-radius: 6px;
    color: white;
    background: #ff4d4d;
    cursor: pointer;
}

.sidebar {
    width: 230px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    background: linear-gradient(#34caca, #1aa853);
    padding-top: 30px;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
}

.sidebar a {
    display: block;
    padding: 12px 20px;
    margin: 10px 15px;
    text-decoration: none;
    color: white;
    font-size: 16px;
    border-radius: 20px;
    transition: 0.3s;
}


.sidebar a:hover {
    background: rgba(255,255,255,0.3);
}

.sidebar button {
    display: block;
    padding: 12px 20px;
    margin: 10px 15px;
    text-decoration: none;
    font-size: 16px;
    transition: 0.3s;
    background: white;
    color: #26bfa3;
    border-radius: 30px;
    border: none;
    font-weight: bold;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}
.wave-container {
    position: fixed;
    top: 0;
    left: 230px;
    width: calc(100% - 230px);
    height: 100vh;
    overflow: hidden;   /* ðŸ”¥ THIS IS KEY */
    z-index: -1;
}
/* ðŸ”¥ TRACK THAT MOVES */
.wave-track {
    position: absolute;
    top: 50%;
    left: 0;
    display: flex;
    width: 200%;              /* ðŸ”¥ FORCE DOUBLE WIDTH */
    transform: translateY(-50%);
    animation: waveMove 40s linear infinite;
}


/* ðŸ”¥ EACH WAVE IMAGE */
.wave {
    width: 50%;               /* ðŸ”¥ HALF of track */
    height: auto;
    flex-shrink: 0;
}


.wave1 {
  animation: moveWave 30s ease-in-out infinite;
}
@keyframes waveMove {
  0% {
    transform: translate(0, -50%);
  }
  100% {
    transform: translate(-50%, -50%);
  }
}



.ptimg{
    margin-left: 30px;
    width: 70%;
    
    border-radius: 12px;
    background: #ffffff;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    
}
.sidebar img {
        width: 150px;
        height: auto;
        padding: 12px 20px;
        margin-left: 5px;
        align-items: center;
        
}
@media (max-width: 1366px) {
  .wave {
    width: 100%;
  }
}
</style></head>
<body>
    <div class="wave-container">
    <div class="wave-track">
      <img src="Software.png" class="wave">
      <img src="Software.png" class="wave">
    </div>
  </div>


<!-- <div id="flash"></div> -->
    <div class="sidebar">
            <div class="ptimg"><img src="PTlogo.png" alt=""></div>
            <br> 

    <a href="home.html">Home</a>
    <a href="employees.html">Employees</a>
    <a href="attendance.html">Attendance</a>
    <a href="stock.html">Stock</a>
    <a href="cust.html">Customers</a>
    <a href="accounts.html">Accounts</a>
    <a href="expenses.html">Expenses</a>

    <br><br><br><br>

    <button onclick="logout()">Logout</button>
</div>
    
<!-- CONTENT -->
 <div class="main-wrapper">
<div class="container" id="att">

    <h2>Attendance</h2>

    <div class="row">
        <div class="inputGroup">
            <label>Employee Name</label>
            <select id="empSelect" class="selectBox">
                <option value="">Select Employee</option>
            </select>
        </div>

        <div class="inputGroup">
            <label>Date</label>
            <input type="date" id="attDate">
        </div>

        <div class="inputGroup"></div>
    </div>

    <div class="btnRow">
        <button id="inBtn">IN</button>
        
    </div>

    <div id="attendanceList"></div>

</div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3yLs6Zx_JuCtGIPVKSrY9gse3ZkAi3Fs",
    authDomain: "printech-c101a.firebaseapp.com",
    projectId: "printech-c101a",
    storageBucket: "printech-c101a.firebasestorage.app",
    messagingSenderId: "629188473697",
    appId: "1:629188473697:web:1ca8e7a5294eb9ec830b20"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

 
  const formatTime12 = () => {
    let now = new Date();
    // seconds: '2-digit' add pannirukaen, appo dhaan calculation accurate-a varum
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
};

  // 1. Fetch Employees for Dropdown
  onSnapshot(collection(db, "EmployeesData"), (snap) => {
      const empSelect = document.getElementById("empSelect");
      empSelect.innerHTML = '<option value="">Select Employee</option>';
      snap.forEach(docSnap => {
          const emp = docSnap.data();
          if (emp.name) {
              let opt = document.createElement("option");
              opt.value = emp.name;
              opt.textContent = emp.name;
              empSelect.appendChild(opt);
          }
      });
  });

  // 2. MARK IN (New Record)
  document.getElementById("inBtn").onclick = async () => {
      const name = document.getElementById("empSelect").value;
      const date = document.getElementById("attDate").value;
      if (!name || !date) return alert("Details fill pannu machi!");

      try {
          await addDoc(collection(db, "AttendanceRecords"), {
              employeeName: name,
              date: date,
              inTime: formatTime12(),
              outTime: "-",
              status: "IN",
              timestamp: serverTimestamp()
          });
          alert(`${name} marked IN! âœ…`);
      } catch (e) { alert("Error: " + e.message); }
  };

  // 3. MARK OUT (Card-kulla irukura button click panna)
  window.markOut = async (id) => {
      try {
          const docRef = doc(db, "AttendanceRecords", id);
          await updateDoc(docRef, {
              outTime: formatTime12(),
              status: "OUT"
          });
          alert("Marked OUT! ðŸš€");
      } catch (e) { alert("Error: " + e.message); }
  };

  // 4. DISPLAY LIST (With Dynamic Button)
  // 4. DISPLAY LIST (With Dynamic Button)
const attList = document.getElementById("attendanceList");

onSnapshot(query(collection(db, "AttendanceRecords"), orderBy("timestamp", "desc")), (snap) => {
    attList.innerHTML = "";
    snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        
        // ðŸ”¥ DATE FORMAT FIX: YYYY-MM-DD -> DD/MM/YYYY
        // Input-la irundhu vara date-ah split panni reverse panni join pandrom
        const formattedDisplayDate = d.date ? d.date.split("-").reverse().join("/") : "-";

        let durationDisplay = d.lunchDuration || '00:00:00';

        let card = document.createElement("div");
        card.className = "attCard";
        card.style.padding = "10px 15px"; 

        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex: 1;">
            <p style="margin: 2px 0;"><b>${d.employeeName}</b> | <small>${formattedDisplayDate}</small></p>
            <p style="margin: 2px 0; font-size: 13px;">IN: ${d.inTime} | OUT: ${d.outTime}</p>
            <div style="margin-top: 8px;">
                ${d.status === 'IN' ? `<button onclick="markOut('${id}')" style="background: linear-gradient(to right, #07AFC0, #1aa853); color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-size:12px; font-weight:bold;">MARK OUT</button>` : ""}
                <button class="delBtn" onclick="deleteAtt('${id}')" style="padding: 5px 12px; font-size:12px;">Delete</button>
            </div>
        </div>

        <div style="width: 220px; background: #f4f9fb; padding: 8px; border-radius: 8px; border-left: 4px solid #07AFC0; font-size: 12px;">
            <p style="margin: 0; display:flex; justify-content:space-between;">
                <b style="color: #07AFC0;">Lunch:</b> 
                <span id="timer-${id}" style="color:#333; font-weight:bold;">${durationDisplay}</span>
            </p>
            <p style="margin: 4px 0 0 0; color: #666;">
                Out: ${d.lunchOut || '-'} | In: ${d.lunchIn || '-'}
            </p>
            <div style="margin-top: 5px;">
                ${!d.lunchOut ? `
                    <button id="lOutBtn-${id}" onclick="startLunch('${id}')" style="background: linear-gradient(to right, #07AFC0, #26bfa3); color:white; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; width:100%; font-weight:bold;">Lunch OUT</button>
                ` : ""}
                ${d.lunchOut && !d.lunchIn ? `
                    <button id="lInBtn-${id}" onclick="endLunch('${id}', '${d.lunchOut}')" style="background: linear-gradient(to right, #1aa853, #07AFC0); color:white; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; width:100%; font-weight:bold;">Lunch IN</button>
                ` : ""}
            </div>
        </div>
    </div>
`;
        attList.appendChild(card);

        if (d.lunchOut && !d.lunchIn) {
            runLiveTimer(id, d.lunchOut);
        }
    });
});
  window.deleteAtt = async (id) => {
      if(confirm("Delete pannelama?")) await deleteDoc(doc(db, "AttendanceRecords", id));
  };

  window.logout = () => { sessionStorage.clear(); window.location.href = "login.html"; };

  window.addEventListener('DOMContentLoaded', () => {
    // 1. Session-la irundhu user data-va edu
    const loggedUser = JSON.parse(sessionStorage.getItem("loggedUser"));
    
    if (loggedUser) {
      // 2. Role "Founder" illana Accounts & Expenses-ah maraichidu
      if (loggedUser.role !== "Founder") {
        // Sidebar-la irukkura Accounts & Expenses links-ah 'id' vechu kandupidi
        const accLink = document.querySelector('a[href="employees.html"]');
        
        
        if (accLink) accLink.style.display = 'none';
        if (expLink) expLink.style.display = 'none';
      }
    } else {
      // Login pannala-na veliya thallu
      window.location.href = "login.html";
    }
  });


  // Live Timer Function
window.runLiveTimer = (id, startTimeStr) => {
    const timerElement = document.getElementById(`timer-${id}`);
    if (!timerElement) return;

    if (window[`interval_${id}`]) clearInterval(window[`interval_${id}`]);

    // 1. Parse "03:17:10 AM" format
    const [time, modifier] = startTimeStr.split(' ');
    const [hoursStr, minutesStr, secondsStr] = time.split(':');
    
    let hours = parseInt(hoursStr);
    let minutes = parseInt(minutesStr);
    let seconds = parseInt(secondsStr);

    if (modifier === 'PM' && hours < 12) hours += 12;
    if (modifier === 'AM' && hours === 12) hours = 0;

    // 2. Exact start time-ah set pannu
    const startTime = new Date();
    startTime.setHours(hours, minutes, seconds, 0); 

    window[`interval_${id}`] = setInterval(() => {
        const now = new Date();
        let diff = now.getTime() - startTime.getTime();

        if (diff < 0) diff = 0;

        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        
        if (document.getElementById(`timer-${id}`)) {
            document.getElementById(`timer-${id}`).innerText = timeStr;
        } else {
            clearInterval(window[`interval_${id}`]);
        }
    }, 1000);
};

// Start Lunch
window.startLunch = async (id) => {
    const docRef = doc(db, "AttendanceRecords", id);
    await updateDoc(docRef, {
        lunchOut: formatTime12(),
        lunchStatus: "LUNCH_OUT"
    });
    alert("Lunch Started! Timer On.");
};

// End Lunch & Calculate Total Time
window.endLunch = async (id) => {
    try {
        const timerVal = document.getElementById(`timer-${id}`).innerText;
        
        // Timer-ah stop pannu
        if (window[`interval_${id}`]) {
            clearInterval(window[`interval_${id}`]);
            window[`interval_${id}`] = null;
        }

        const docRef = doc(db, "AttendanceRecords", id);
        await updateDoc(docRef, {
            lunchIn: formatTime12(),
            lunchDuration: timerVal,
            lunchStatus: "COMPLETED"
        });
        
        alert(`Lunch Finished! Time: ${timerVal}`);
    } catch (e) { alert("Error: " + e.message); }
};
</script>

</body>
</html>